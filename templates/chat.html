<!-- Floating AI Button -->
<div id="chat-circle" class="chat-circle">AI</div>

<!-- Chatbox -->
<div id="chat-box" class="chat-box">
  <div class="chat-header">
    AI Chat Assistant
    <div>
      <button id="clear-chat" class="clear-btn">ðŸ—‘</button>
      <button id="close-chat" class="close-btn">&times;</button>
    </div>
  </div>
  <div id="chat-content" class="chat-content"></div>
  <div class="chat-input-box">
    <input id="user-input" type="text" placeholder="Type your answer..." />
    <button id="send-btn">Send</button>
  </div>
</div>

<style>
/* Floating Circle Button */
.chat-circle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #007bff;
  color: white;
  font-weight: bold;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  z-index: 1000;
  transition: transform 0.3s ease;
}
.chat-circle:hover {
  transform: scale(1.1);
}

/* Chatbox */
.chat-box {
  display: none;
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 350px;
  height: 450px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  flex-direction: column;
  overflow: hidden;
  z-index: 1000;
  animation: fadeInUp 0.3s ease;
}
@keyframes fadeInUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.chat-header {
  background: #007bff;
  color: white;
  padding: 12px;
  font-size: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-content {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  font-size: 14px;
  background: #f9f9f9;
}

/* Chat bubbles */
.message {
  margin: 8px 0;
  padding: 8px 12px;
  border-radius: 10px;
  max-width: 80%;
  clear: both;
}
.message.user {
  background: #007bff;
  color: white;
  float: right;
  border-bottom-right-radius: 2px;
}
.message.ai {
  background: #e9ecef;
  color: black;
  float: left;
  border-bottom-left-radius: 2px;
}

/* Typing dots */
.typing {
  display: inline-block;
}
.typing span {
  display: inline-block;
  width: 6px;
  height: 6px;
  margin: 0 2px;
  background: #555;
  border-radius: 50%;
  animation: blink 1.4s infinite both;
}
.typing span:nth-child(2) { animation-delay: 0.2s; }
.typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink {
  0%, 80%, 100% { opacity: 0; }
  40% { opacity: 1; }
}

.chat-input-box {
  display: flex;
  border-top: 1px solid #ddd;
}
.chat-input-box input {
  flex: 1;
  border: none;
  padding: 10px;
  font-size: 14px;
}
.chat-input-box button {
  background: #007bff;
  border: none;
  color: white;
  padding: 10px 15px;
  cursor: pointer;
}

.clear-btn, .close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const chatCircle = document.getElementById("chat-circle");
  const chatBox = document.getElementById("chat-box");
  const closeChat = document.getElementById("close-chat");
  const sendBtn = document.getElementById("send-btn");
  const userInput = document.getElementById("user-input");
  const chatContent = document.getElementById("chat-content");
  const clearChat = document.getElementById("clear-chat");

  let mode = null;
  let currentQuestionIndex = 0;
  let answers = [];

  const questions = {
    tb: [
      "Do you have a persistent cough lasting more than 2 weeks?",
      "Have you been coughing up blood?",
      "Do you experience night sweats?",
      "Do you feel chest pain?",
      "Have you lost weight recently?",
      "Do you often feel fatigued or weak?"
    ],
    stroke: [
      "Have you experienced sudden weakness on one side of the body?",
      "Do you have difficulty speaking or understanding speech?",
      "Have you experienced sudden vision problems?",
      "Do you have sudden dizziness or loss of balance?",
      "Do you have a severe sudden headache?",
      "Has your face drooped on one side suddenly?"
    ]
  };

  // Open chatbox
  chatCircle.addEventListener("click", () => {
    chatBox.style.display = "flex";
    chatCircle.style.display = "none";
    aiMessage("Hi ðŸ‘‹ Type 'TB' or 'Stroke' to begin your risk check.");
  });

  // Close chatbox
  closeChat.addEventListener("click", () => {
    chatBox.style.display = "none";
    chatCircle.style.display = "flex";
    resetChat();
  });

  // Clear chat
  clearChat.addEventListener("click", () => {
    chatContent.innerHTML = "";
    resetChat();
  });

  // Send message
  sendBtn.addEventListener("click", () => {
    const msg = userInput.value.trim();
    if (msg) {
      appendMessage("You", msg, "user");
      processUserMessage(msg);
      userInput.value = "";
    }
  });

  // Append user/AI message
  function appendMessage(sender, text, type) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", type);
    msgDiv.textContent = text;
    chatContent.appendChild(msgDiv);
    chatContent.scrollTop = chatContent.scrollHeight;
  }

  // AI typing effect
  function aiMessage(text) {
    const typingDiv = document.createElement("div");
    typingDiv.classList.add("message", "ai");
    typingDiv.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
    chatContent.appendChild(typingDiv);
    chatContent.scrollTop = chatContent.scrollHeight;

    setTimeout(() => {
      typingDiv.innerHTML = text;
    }, 1000); // delay for effect
  }

  function processUserMessage(msg) {
    msg = msg.toLowerCase();

    if (!mode) {
      if (msg.includes("tb")) {
        mode = "tb";
        aiMessage("Okay, let's check TB risk. Answer Yes/No.");
        askNextQuestion();
      } else if (msg.includes("stroke")) {
        mode = "stroke";
        aiMessage("Okay, let's check Stroke risk. Answer Yes/No.");
        askNextQuestion();
      } else {
        aiMessage("Please type 'TB' or 'Stroke' to begin.");
      }
      return;
    }

    // Collect answers
    if (mode && currentQuestionIndex < questions[mode].length) {
      answers.push(msg);

      // Ask next question
      currentQuestionIndex++;
      if (currentQuestionIndex < questions[mode].length) {
        askNextQuestion();
      } else {
        // Done asking â†’ send to backend
        fetch("/chatbot", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({mode, answers})
        })
        .then(res => res.json())
        .then(data => {
          aiMessage(data.result);
          resetChat();
        });
      }
    }
  }

  function askNextQuestion() {
    aiMessage(questions[mode][currentQuestionIndex]);
  }

  function resetChat() {
    mode = null;
    currentQuestionIndex = 0;
    answers = [];
  }
});
</script>
